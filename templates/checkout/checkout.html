{% extends 'base.html' %}

{% block title %}Checkout - Ngopiin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 my-[80px] min-h-[75vh]">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 md:mb-8">Checkout</h1>

    {% if pending_transaction %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 md:p-4 mb-6 md:mb-8">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <div class="text-sm text-yellow-700">
                    <p class="font-medium mb-2">Anda memiliki transaksi yang belum selesai.</p>
                    <p>Total pembayaran: Rp {{ total|floatformat:0 }}</p>
                    <p>Metode pembayaran: {{ pending_transaction.payment_type }}</p>
                    <button onclick="processCheckout()" 
                            class="mt-3 bg-yellow-800 text-white px-4 py-2 rounded hover:bg-yellow-700 transition">
                        Lanjutkan Pembayaran
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
        <!-- Customer Information Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <h2 class="text-lg md:text-xl font-semibold mb-4 md:mb-6">Informasi Pelanggan</h2>
                <form id="checkoutForm" class="space-y-6" onsubmit="return false;">
                    {% csrf_token %}
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nama Lengkap <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" required
                               value="{{ pending_transaction.customer_name|default:'' }}"
                               {% if pending_transaction %}readonly{% endif %}
                               class="mt-2 p-2 w-full border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent rounded-md">
                        <p id="nameError" class="mt-1 text-sm text-red-600 hidden">Nama lengkap harus diisi</p>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label>
                        <input type="email" id="email" name="email" required
                               value="{{ pending_transaction.customer_email|default:'' }}"
                               {% if pending_transaction %}readonly{% endif %}
                               class="mt-2 p-2 w-full border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent rounded-md">
                        <p id="emailError" class="mt-1 text-sm text-red-600 hidden">Email harus diisi dengan format yang benar</p>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Nomor Telepon <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" name="phone" required
                               pattern="[0-9]{10,13}"
                               value="{{ pending_transaction.customer_phone|default:'' }}"
                               {% if pending_transaction %}readonly{% endif %}
                               class="mt-2 p-2 w-full border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent rounded-md">
                        <p id="phoneError" class="mt-1 text-sm text-red-600 hidden">Nomor telepon harus diisi (10-13 digit)</p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <h2 class="text-lg md:text-xl font-semibold mb-4 md:mb-6">Ringkasan Pesanan</h2>
                <div class="space-y-4">
                    {% for item in cart_items %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">{{ item.product.name }} Ã— {{ item.quantity }}</span>
                        <span class="font-medium">Rp {{ item.subtotal|floatformat:0 }}</span>
                    </div>
                    {% endfor %}
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="flex justify-between">
                            <span class="text-lg font-semibold">Total</span>
                            <span class="text-lg font-semibold">Rp {{ total|floatformat:0 }}</span>
                        </div>
                    </div>
                    <button type="button" onclick="validateAndProcessCheckout()"
                            class="w-full bg-yellow-800 text-white py-3 rounded-lg hover:bg-yellow-700 transition">
                        {% if pending_transaction %}
                        Lanjutkan Pembayaran
                        {% else %}
                        Bayar Sekarang
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 md:mt-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 md:mb-6">Metode Pembayaran</h2>
        <div class="space-y-4">
            <div class="flex items-center">
                <input type="radio" id="cashless" name="payment_type" value="Cashless" 
                       class="h-4 w-4 text-yellow-800 focus:ring-yellow-500" checked>
                <label for="cashless" class="ml-3 block text-sm font-medium text-gray-700">
                    Pembayaran Online (Cashless)
                </label>
            </div>
            <div class="flex items-center">
                <input type="radio" id="cash" name="payment_type" value="Cash" 
                       class="h-4 w-4 text-yellow-800 focus:ring-yellow-500">
                <label for="cash" class="ml-3 block text-sm font-medium text-gray-700">
                    Bayar di Kasir (Cash)
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Error</h3>
        <p id="errorMessage" class="text-gray-600 mb-6"></p>
        <button onclick="closeErrorModal()" class="w-full bg-yellow-800 text-white py-2 rounded hover:bg-yellow-700">
            Tutup
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if midtrans_is_production %}
<script src="https://app.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
{% else %}
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>
{% endif %}
<script>
function showError(message) {
    const modal = document.getElementById('errorModal');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeErrorModal() {
    const modal = document.getElementById('errorModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function validateForm() {
    if (document.querySelector('[data-pending-transaction]')) {
        return true;  // Skip validation for pending transactions
    }

    const name = document.getElementById('name');
    const email = document.getElementById('email');
    const phone = document.getElementById('phone');
    
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const phoneError = document.getElementById('phoneError');
    
    let isValid = true;
    
    // Reset error messages
    nameError.classList.add('hidden');
    emailError.classList.add('hidden');
    phoneError.classList.add('hidden');
    
    // Validate name
    if (!name.value.trim()) {
        nameError.classList.remove('hidden');
        isValid = false;
    }
    
    // Validate email
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email.value.trim() || !emailPattern.test(email.value)) {
        emailError.classList.remove('hidden');
        isValid = false;
    }
    
    // Validate phone
    const phonePattern = /^[0-9]{10,13}$/;
    if (!phone.value.trim() || !phonePattern.test(phone.value)) {
        phoneError.classList.remove('hidden');
        isValid = false;
    }
    
    return isValid;
}

function validateAndProcessCheckout() {
    if (validateForm()) {
        processCheckout();
    } else {
        // Scroll to the first error
        const firstError = document.querySelector('.text-red-600:not(.hidden)');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

function processCheckout() {
    const form = document.getElementById('checkoutForm');
    const formData = new FormData(form);
    
    // Tambahkan payment_type ke formData
    const selectedPaymentType = document.querySelector('input[name="payment_type"]:checked');
    formData.append('payment_type', selectedPaymentType ? selectedPaymentType.value : 'Cashless');
    
    fetch('/checkout/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
            return;
        }
        
        if (data.payment_type === 'Cash') {
            window.location.href = data.redirect_url;
            return;
        }
        
        // Lanjutkan dengan Midtrans untuk pembayaran cashless
        snap.pay(data.token, {
            onSuccess: function(result) {
                updateTransactionStatus(data.order_id, 'success')
                    .then(() => {
                        window.location.href = '{% url "apps:payment_status" %}?status=success';
                    });
            },
            onPending: function(result) {
                updateTransactionStatus(data.order_id, 'pending')
                    .then(() => {
                        window.location.href = '{% url "apps:payment_status" %}?status=pending';
                    });
            },
            onError: function(result) {
                updateTransactionStatus(data.order_id, 'failure')
                    .then(() => {
                        window.location.href = '{% url "apps:payment_status" %}?status=error';
                    });
            },
            onClose: function() {
                console.log('Customer closed the popup without finishing the payment');
            }
        });
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Terjadi kesalahan saat memproses pembayaran');
    });
}

function updateTransactionStatus(orderId, status) {
    return fetch('{% url "apps:update_transaction_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            order_id: orderId,
            status: status
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Gagal mengupdate status transaksi');
        }
        return response.json();
    })
    .catch(error => {
        console.error('Error updating transaction status:', error);
    });
}
</script>
{% endblock %} 
