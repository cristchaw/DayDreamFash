{% extends 'base.html' %}

{% block title %}Keranjang Belanja - Ngopiin{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mx-auto px-4 py-12 my-[80px] h-[75vh]">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Keranjang Belanja</h1>

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                {% for item in cart_items %}
                <div class="p-4 sm:p-6 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                    <div class="flex items-center">
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                             class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded">
                        <div class="ml-4 flex-grow">
                            <h3 class="text-sm sm:text-lg font-semibold text-gray-900">{{ item.product.name }}</h3>
                            <p class="text-xs sm:text-base text-gray-600">Rp {{ item.product.price|floatformat:0 }}</p>
                        </div>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <div class="flex items-center border rounded">
                                <button type="button" 
                                        onclick="updateQuantity({{ item.product.id }}, 'decrease')"
                                        class="px-2 sm:px-3 py-1 text-gray-600 hover:bg-gray-100 text-sm sm:text-base">
                                    -
                                </button>
                                <span id="quantity-{{ item.product.id }}" 
                                      class="px-2 sm:px-3 py-1 border-x text-sm sm:text-base">
                                    {{ item.quantity }}
                                </span>
                                <button type="button"
                                        onclick="updateQuantity({{ item.product.id }}, 'increase')"
                                        class="px-2 sm:px-3 py-1 text-gray-600 hover:bg-gray-100 text-sm sm:text-base">
                                    +
                                </button>
                            </div>
                            <span id="subtotal-{{ item.product.id }}" 
                                  class="font-semibold text-sm sm:text-base">
                                Rp {{ item.subtotal|floatformat:0 }}
                            </span>
                            <form method="post" action="{% url 'apps:remove_from_cart' item.product.id %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">Ringkasan Pesanan</h2>
                <div class="space-y-4">
                    <div class="flex justify-between text-sm sm:text-base">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-semibold">Rp {{ total|floatformat:0 }}</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between">
                            <span class="text-base sm:text-lg font-semibold">Total</span>
                            <span class="text-base sm:text-lg font-semibold cart-total">Rp {{ total|floatformat:0 }}</span>
                        </div>
                    </div>
                    <a href="{% url 'apps:checkout' %}" 
                       class="block w-full bg-yellow-800 text-white text-center py-2 sm:py-3 rounded-lg hover:bg-yellow-700 transition text-sm sm:text-base">
                        Lanjut ke Pembayaran
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        <h2 class="mt-4 text-lg font-medium text-gray-900">Keranjang Belanja Kosong</h2>
        <p class="mt-2 text-gray-500">Anda belum menambahkan produk ke keranjang.</p>
        <a href="{% url 'apps:product_list' %}" 
           class="mt-6 inline-block bg-yellow-800 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition">
            Lihat Menu
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateQuantity(productId, action) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/update-cart/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update quantity display
            document.getElementById(`quantity-${productId}`).textContent = data.quantity;
            
            // Update subtotal display
            document.getElementById(`subtotal-${productId}`).textContent = 
                `Rp ${data.subtotal.toLocaleString('id-ID')}`;
            
            // Update total display
            const totalElements = document.querySelectorAll('.cart-total');
            totalElements.forEach(element => {
                element.textContent = `Rp ${data.total.toLocaleString('id-ID')}`;
            });
            
            // Update cart count in header
            document.getElementById('cart-count').textContent = data.cart_count;
            document.getElementById('mobile-cart-count').textContent = data.cart_count;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mengupdate keranjang');
    });
}
</script>
{% endblock %} 
